name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      run: |
        cd $HOME
        rm -rf spoofing
        git clone ${{ github.server_url }}/${{ github.repository }}.git spoofing
        cd spoofing
    
    - name: Create environment file
      run: |
        cd $HOME/spoofing
        cat > .env << EOF
        MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
        MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
        MYSQL_USER=${{ secrets.MYSQL_USER }}
        MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
        EOF
    
    - name: Deploy application
      run: |
        cd $HOME/spoofing
        docker-compose -f docker-compose.prod.yml down
        docker-compose -f docker-compose.prod.yml up -d --build